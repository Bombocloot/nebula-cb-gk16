<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nebula - RGB Controller</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #000;
            --bg2: #0a0a0a;
            --card: #111;
            --border: rgba(255, 255, 255, 0.1);
            --text: #fff;
            --dim: #666;
            --accent: #fff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .titlebar {
            height: 30px;
            background: var(--bg2);
            display: flex;
            align-items: center;
            padding: 0 10px;
            -webkit-app-region: drag;
            border-bottom: 1px solid var(--border);
        }

        .window-controls {
            display: flex;
            gap: 6px;
            -webkit-app-region: no-drag;
        }

        .window-btn {
            width: 11px;
            height: 11px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
        }

        .btn-close {
            background: #ff5f57;
        }

        .btn-minimize {
            background: #ffbd2e;
        }

        .titlebar-title {
            flex: 1;
            text-align: center;
            font-size: 11px;
            color: var(--dim);
        }

        .top-nav {
            background: var(--bg2);
            border-bottom: 1px solid var(--border);
            display: flex;
            padding: 0 10px;
            gap: 2px;
            height: 36px;
            align-items: center;
        }

        .nav-tab {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            color: var(--dim);
            font-size: 10px;
            font-weight: 500;
            border: none;
            background: none;
        }

        .nav-tab:hover {
            color: var(--text);
        }

        .nav-tab.active {
            background: var(--accent);
            color: #000;
        }

        .nav-tab .material-symbols-outlined {
            font-size: 14px;
        }

        .nav-spacer {
            flex: 1;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 9px;
            color: var(--dim);
        }

        .status-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: #22c55e;
        }

        .main-layout {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .page-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .apply-bar {
            background: var(--bg2);
            border-top: 1px solid var(--border);
            padding: 8px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .apply-bar .status-text {
            flex: 1;
            font-size: 9px;
            color: var(--dim);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }

        .btn-primary {
            background: var(--accent);
            color: #000;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            border: 1px solid var(--border);
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
        }

        .card-title {
            font-size: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--dim);
            margin-bottom: 8px;
        }

        .mode-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 4px;
        }

        .mode-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 6px 4px;
            cursor: pointer;
            text-align: center;
        }

        .mode-card:hover {
            border-color: var(--accent);
        }

        .mode-card.selected {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }

        .mode-card .material-symbols-outlined {
            font-size: 16px;
            display: block;
            margin-bottom: 1px;
        }

        .mode-card span:last-child {
            font-size: 8px;
        }

        .color-palette {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .color-swatch {
            width: 22px;
            height: 22px;
            border-radius: 3px;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .color-swatch:hover {
            transform: scale(1.1);
        }

        .color-swatch.selected {
            border-color: #fff;
            box-shadow: 0 0 6px currentColor;
        }

        .slider-group {
            margin-bottom: 6px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            margin-bottom: 3px;
        }

        .slider-value {
            color: var(--accent);
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            height: 3px;
            -webkit-appearance: none;
            background: var(--border);
            border-radius: 2px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 10px;
            height: 10px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }

        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }

        .toggle-label {
            font-size: 9px;
        }

        .toggle-switch {
            position: relative;
            width: 28px;
            height: 16px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: var(--border);
            border-radius: 16px;
            transition: 0.2s;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            height: 10px;
            width: 10px;
            left: 3px;
            bottom: 3px;
            background: #fff;
            border-radius: 50%;
            transition: 0.2s;
        }

        .toggle-switch input:checked+.toggle-slider {
            background: var(--accent);
        }

        .toggle-switch input:checked+.toggle-slider::before {
            transform: translateX(12px);
        }

        .preset-select {
            width: 100%;
            padding: 5px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 3px;
            color: #fff;
            font-size: 9px;
        }

        .preset-select option {
            background: #1a1a1a;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 8px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
        }

        .stat-label {
            font-size: 7px;
            text-transform: uppercase;
            color: var(--dim);
        }

        .vis-count {
            text-align: center;
            margin-bottom: 10px;
        }

        .vis-count .num {
            font-size: 36px;
            font-weight: 700;
        }

        .vis-count .lbl {
            font-size: 9px;
            text-transform: uppercase;
            color: var(--dim);
        }

        .full-kb {
            background: #000;
            border-radius: 4px;
            padding: 8px;
        }

        .kb-row {
            display: flex;
            gap: 2px;
            margin-bottom: 2px;
            justify-content: center;
        }

        .kb-key {
            min-width: 20px;
            height: 20px;
            background: #1a1a1a;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5px;
            color: #444;
            cursor: pointer;
            transition: 0.1s;
            user-select: none;
            -webkit-user-select: none;
        }

        .kb-key:hover {
            background: #2a2a2a;
            color: #888;
        }

        .kb-key:active {
            transform: scale(0.95);
        }

        .kb-key.active {
            background: #fff !important;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
            color: #000;
        }

        .kb-key.painted {
            color: #000;
        }

        .key-w125 {
            min-width: 25px;
        }

        .key-w15 {
            min-width: 30px;
        }

        .key-w175 {
            min-width: 35px;
        }

        .key-w2 {
            min-width: 40px;
        }

        .key-w225 {
            min-width: 45px;
        }

        .key-w275 {
            min-width: 55px;
        }

        .key-space {
            min-width: 120px;
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        ::-webkit-scrollbar {
            width: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px;
        }
    </style>
</head>

<body>
    <div class="titlebar">
        <div class="window-controls">
            <button class="window-btn btn-close" id="btnClose"></button>
            <button class="window-btn btn-minimize" id="btnMinimize"></button>
        </div>
        <span class="titlebar-title">Nebula</span>
        <div style="width: 28px;"></div>
    </div>

    <nav class="top-nav">
        <button class="nav-tab active" data-page="lighting"><span
                class="material-symbols-outlined">palette</span>Lighting</button>
        <button class="nav-tab" data-page="smart"><span
                class="material-symbols-outlined">auto_awesome</span>Smart</button>
        <button class="nav-tab" data-page="perkey"><span class="material-symbols-outlined">brush</span>Per-Key</button>
        <button class="nav-tab" data-page="visualizer"><span
                class="material-symbols-outlined">keyboard</span>Visualizer</button>
        <button class="nav-tab" data-page="stats"><span class="material-symbols-outlined">analytics</span>Stats</button>
        <div class="nav-spacer"></div>
        <div class="status-badge">
            <div class="status-dot"></div><span id="statusText">Ready</span>
        </div>
    </nav>

    <div class="main-layout">
        <div class="page-content">
            <div class="page active" id="page-lighting">
                <div class="card">
                    <div class="card-title">Mode</div>
                    <div class="mode-grid" id="modeGrid"></div>
                </div>
                <div class="two-col">
                    <div class="card">
                        <div class="slider-group">
                            <div class="slider-header"><span>Speed</span><span class="slider-value"
                                    id="speedVal">100%</span></div>
                            <input type="range" id="speedSlider" min="0" max="100" value="100">
                        </div>
                        <div class="slider-group">
                            <div class="slider-header"><span>Brightness</span><span class="slider-value"
                                    id="brightVal">100%</span></div>
                            <input type="range" id="brightSlider" min="0" max="100" value="100">
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title">Color</div>
                        <div class="color-palette" id="colorPalette"></div>
                        <div class="toggle-row" style="margin-top: 4px;">
                            <span class="toggle-label" id="dirLabel">Dir: Right</span>
                            <label class="toggle-switch"><input type="checkbox" id="dirToggle"><span
                                    class="toggle-slider"></span></label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="page" id="page-smart">
                <div class="card">
                    <div class="toggle-row"><span class="toggle-label">Smart Mode</span><label
                            class="toggle-switch"><input type="checkbox" id="smartToggle"><span
                                class="toggle-slider"></span></label></div>
                    <div class="toggle-row"><span class="toggle-label">Neighbor Flash</span><label
                            class="toggle-switch"><input type="checkbox" id="neighborToggle" checked><span
                                class="toggle-slider"></span></label></div>
                </div>
                <div class="two-col">
                    <div class="card">
                        <div class="card-title">Active</div>
                        <div class="color-palette" id="activeColors"></div>
                    </div>
                    <div class="card">
                        <div class="card-title">Idle</div>
                        <div class="color-palette" id="idleColors"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="slider-group">
                        <div class="slider-header"><span>Timeout</span><span class="slider-value"
                                id="timeoutVal">15s</span></div>
                        <input type="range" id="timeoutSlider" min="5" max="60" value="15">
                    </div>
                </div>
            </div>

            <div class="page" id="page-perkey">
                <div class="two-col">
                    <div class="card">
                        <div class="card-title">Paint Color</div>
                        <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                            <input type="color" id="paintColor" value="#ffffff"
                                style="width: 28px; height: 22px; border: none; border-radius: 2px;">
                            <input type="text" id="paintHex" value="#FFFFFF"
                                style="flex: 1; padding: 4px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 2px; color: #fff; font-family: monospace; font-size: 8px;">
                        </div>
                        <div class="color-palette" id="quickColors"></div>
                    </div>
                    <div class="card">
                        <div class="card-title">Presets</div>
                        <select class="preset-select" id="presetSelect">
                            <option value="">Select...</option>
                            <option value="rainbow">Rainbow</option>
                            <option value="gaming">Gaming</option>
                            <option value="gradient">Gradient</option>
                            <option value="fill">Fill All</option>
                            <option value="clear">Clear</option>
                        </select>
                        <div class="toggle-row" style="margin-top: 4px;"><span
                                class="toggle-label">Reactive</span><label class="toggle-switch"><input type="checkbox"
                                    id="reactiveToggle"><span class="toggle-slider"></span></label></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Keyboard</div>
                    <div class="full-kb" id="perkeyKb"></div>
                </div>
            </div>

            <div class="page" id="page-visualizer">
                <div class="vis-count">
                    <div class="num" id="keyCount">0</div>
                    <div class="lbl">Keys Pressed</div>
                </div>
                <div class="card">
                    <div class="full-kb" id="visKb"></div>
                </div>
            </div>

            <div class="page" id="page-stats">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalKeys">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="kpmVal">0</div>
                        <div class="stat-label">KPM</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="sessionTime">0:00</div>
                        <div class="stat-label">Session</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="sessionKeys">0</div>
                        <div class="stat-label">Keys</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Top Keys</div>
                    <div id="topKeys"></div>
                </div>
                <button class="btn btn-secondary" id="resetBtn" style="width: 100%;">Reset</button>
            </div>
        </div>
        <div class="apply-bar"><span class="status-text" id="footerStatus">Ready</span><button class="btn btn-primary"
                id="applyBtn">Apply</button></div>
    </div>

    <script>
        // COLORS: Index matches Firefly firmware (0=Red, 1=Green, 2=Yellow, 3=Blue, 4=Cyan, 5=Magenta, 6=White, 7=Off)
        const COLORS = [
            { n: 'Red', h: '#FF0000' },
            { n: 'Green', h: '#00FF00' },
            { n: 'Yellow', h: '#FFFF00' },
            { n: 'Blue', h: '#0000FF' },
            { n: 'Cyan', h: '#00FFFF' },
            { n: 'Magenta', h: '#FF00FF' },
            { n: 'White', h: '#FFFFFF' },
            { n: 'Off', h: '#000000' }
        ];

        const MODES = [
            { id: 1, n: 'Breathe', i: 'blur_on' },
            { id: 2, n: 'Fade', i: 'gradient' },
            { id: 3, n: 'Reactive', i: 'touch_app' },
            { id: 4, n: 'Star', i: 'star' },
            { id: 5, n: 'Laser', i: 'bolt' },
            { id: 6, n: 'Wave', i: 'waves' },
            { id: 7, n: 'Neon', i: 'fluorescent' },
            { id: 8, n: 'Rain', i: 'water_drop' },
            { id: 9, n: 'Ripple', i: 'ripples' },
            { id: 10, n: 'Wave2', i: 'tsunami' },
            { id: 11, n: 'Swirl', i: 'cyclone' },
            { id: 0, n: 'Static', i: 'lightbulb' }
        ];

        const LAYOUT = [
            [{ k: 'ESC' }, { s: .5 }, { k: 'F1' }, { k: 'F2' }, { k: 'F3' }, { k: 'F4' }, { s: .5 }, { k: 'F5' }, { k: 'F6' }, { k: 'F7' }, { k: 'F8' }, { s: .5 }, { k: 'F9' }, { k: 'F10' }, { k: 'F11' }, { k: 'F12' }, { s: .25 }, { k: 'PRTSC', l: 'Prt' }, { k: 'SCRLK', l: 'Scr' }, { k: 'PAUSE', l: 'Pau' }],
            [{ k: 'GRAVE', l: '`' }, { k: '1' }, { k: '2' }, { k: '3' }, { k: '4' }, { k: '5' }, { k: '6' }, { k: '7' }, { k: '8' }, { k: '9' }, { k: '0' }, { k: 'MINUS', l: '-' }, { k: 'EQUAL', l: '=' }, { k: 'BACKSPACE', l: '←', w: 2 }, { s: .25 }, { k: 'INSERT', l: 'Ins' }, { k: 'HOME', l: 'Hom' }, { k: 'PGUP', l: 'PgU' }],
            [{ k: 'TAB', w: 1.5 }, { k: 'Q' }, { k: 'W' }, { k: 'E' }, { k: 'R' }, { k: 'T' }, { k: 'Y' }, { k: 'U' }, { k: 'I' }, { k: 'O' }, { k: 'P' }, { k: 'LBRACKET', l: '[' }, { k: 'RBRACKET', l: ']' }, { k: 'BACKSLASH', l: '\\', w: 1.5 }, { s: .25 }, { k: 'DELETE', l: 'Del' }, { k: 'END' }, { k: 'PGDN', l: 'PgD' }],
            [{ k: 'CAPSLOCK', l: 'Caps', w: 1.75 }, { k: 'A' }, { k: 'S' }, { k: 'D' }, { k: 'F' }, { k: 'G' }, { k: 'H' }, { k: 'J' }, { k: 'K' }, { k: 'L' }, { k: 'SEMICOLON', l: ';' }, { k: 'QUOTE', l: "'" }, { k: 'ENTER', w: 2.25 }],
            [{ k: 'LSHIFT', l: 'Shift', w: 2.25 }, { k: 'Z' }, { k: 'X' }, { k: 'C' }, { k: 'V' }, { k: 'B' }, { k: 'N' }, { k: 'M' }, { k: 'COMMA', l: ',' }, { k: 'PERIOD', l: '.' }, { k: 'SLASH', l: '/' }, { k: 'RSHIFT', l: 'Shift', w: 2.75 }, { s: 1.25 }, { k: 'UP', l: '↑' }],
            [{ k: 'LCTRL', l: 'Ctrl', w: 1.25 }, { k: 'LWIN', l: 'Win', w: 1.25 }, { k: 'LALT', l: 'Alt', w: 1.25 }, { k: 'SPACE', l: '', w: 6.25 }, { k: 'RALT', l: 'Alt', w: 1.25 }, { k: 'FN', w: 1.25 }, { k: 'MENU', w: 1.25 }, { k: 'RCTRL', l: 'Ctrl', w: 1.25 }, { s: .25 }, { k: 'LEFT', l: '←' }, { k: 'DOWN', l: '↓' }, { k: 'RIGHT', l: '→' }]
        ];

        const VK = {
            27: 'ESC', 112: 'F1', 113: 'F2', 114: 'F3', 115: 'F4', 116: 'F5', 117: 'F6', 118: 'F7', 119: 'F8', 120: 'F9', 121: 'F10', 122: 'F11', 123: 'F12',
            44: 'PRTSC', 145: 'SCRLK', 19: 'PAUSE',
            192: 'GRAVE', 49: '1', 50: '2', 51: '3', 52: '4', 53: '5', 54: '6', 55: '7', 56: '8', 57: '9', 48: '0', 189: 'MINUS', 187: 'EQUAL', 8: 'BACKSPACE',
            45: 'INSERT', 36: 'HOME', 33: 'PGUP', 46: 'DELETE', 35: 'END', 34: 'PGDN',
            9: 'TAB', 81: 'Q', 87: 'W', 69: 'E', 82: 'R', 84: 'T', 89: 'Y', 85: 'U', 73: 'I', 79: 'O', 80: 'P', 219: 'LBRACKET', 221: 'RBRACKET', 220: 'BACKSLASH',
            20: 'CAPSLOCK', 65: 'A', 83: 'S', 68: 'D', 70: 'F', 71: 'G', 72: 'H', 74: 'J', 75: 'K', 76: 'L', 186: 'SEMICOLON', 222: 'QUOTE', 13: 'ENTER',
            160: 'LSHIFT', 161: 'RSHIFT', 90: 'Z', 88: 'X', 67: 'C', 86: 'V', 66: 'B', 78: 'N', 77: 'M', 188: 'COMMA', 190: 'PERIOD', 191: 'SLASH',
            162: 'LCTRL', 163: 'RCTRL', 91: 'LWIN', 164: 'LALT', 165: 'RALT', 32: 'SPACE', 93: 'MENU', 38: 'UP', 40: 'DOWN', 37: 'LEFT', 39: 'RIGHT'
        };

        let selMode = 9, selColor = 4, actColor = 4, idleColor = 7, dir = 0;
        let perkey = {}, paintColor = '#ffffff', curPage = 'lighting';
        let sessStart = Date.now(), sessKeys = 0;

        const setStatus = m => { document.getElementById('statusText').textContent = m; document.getElementById('footerStatus').textContent = m; };

        function buildKb(id, onClick) {
            const el = document.getElementById(id);
            el.innerHTML = LAYOUT.map(row => `<div class="kb-row">${row.map(k => {
                if (k.s !== undefined) return `<div style="width: ${k.s * 20}px"></div>`;
                const w = k.w ? `key-w${String(k.w).replace('.', '')}` : '';
                const sp = k.k === 'SPACE' ? 'key-space' : '';
                const lbl = k.l !== undefined ? k.l : k.k;
                return `<div class="kb-key ${w} ${sp}" data-key="${k.k}">${lbl}</div>`;
            }).join('')}</div>`).join('');
            if (onClick) el.querySelectorAll('.kb-key').forEach(k => k.onclick = () => onClick(k));
        }

        function colors(id, sel, cb) {
            const el = document.getElementById(id);
            el.innerHTML = COLORS.map((c, i) => `<div class="color-swatch ${sel === i ? 'selected' : ''}" style="background:${c.h};${c.h === '#000000' ? 'border:1px dashed #444' : ''}" data-i="${i}"></div>`).join('');
            el.querySelectorAll('.color-swatch').forEach(s => s.onclick = () => cb(+s.dataset.i));
        }

        // Navigation
        document.querySelectorAll('.nav-tab').forEach(t => t.onclick = () => {
            document.querySelectorAll('.nav-tab').forEach(x => x.classList.remove('active'));
            t.classList.add('active');
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            curPage = t.dataset.page;
            document.getElementById('page-' + curPage).classList.add('active');
        });

        document.getElementById('btnClose').onclick = () => window.api?.windowControl('close');
        document.getElementById('btnMinimize').onclick = () => window.api?.windowControl('minimize');

        // Lighting
        function initLight() {
            document.getElementById('modeGrid').innerHTML = MODES.map(m =>
                `<div class="mode-card ${selMode === m.id ? 'selected' : ''}" data-m="${m.id}"><span class="material-symbols-outlined">${m.i}</span><span>${m.n}</span></div>`
            ).join('');
            document.querySelectorAll('.mode-card').forEach(c => c.onclick = () => { selMode = +c.dataset.m; initLight(); });
            colors('colorPalette', selColor, i => { selColor = i; initLight(); });
        }

        document.getElementById('speedSlider').oninput = e => document.getElementById('speedVal').textContent = e.target.value + '%';
        document.getElementById('brightSlider').oninput = e => document.getElementById('brightVal').textContent = e.target.value + '%';
        document.getElementById('dirToggle').onchange = e => { dir = e.target.checked ? 1 : 0; document.getElementById('dirLabel').textContent = 'Dir: ' + (dir ? 'Left' : 'Right'); };

        // Smart
        function initSmart() {
            colors('activeColors', actColor, i => { actColor = i; initSmart(); });
            colors('idleColors', idleColor, i => { idleColor = i; initSmart(); });
        }
        document.getElementById('timeoutSlider').oninput = e => document.getElementById('timeoutVal').textContent = e.target.value + 's';

        // Per-Key
        function initPerkey() {
            const qc = ['#FF0000', '#00FF00', '#FFFF00', '#0000FF', '#00FFFF', '#FF00FF', '#FFFFFF', '#FF8800', '#8800FF'];
            document.getElementById('quickColors').innerHTML = qc.map(c => `<div class="color-swatch" style="background:${c}" data-hex="${c}"></div>`).join('');
            document.getElementById('quickColors').querySelectorAll('.color-swatch').forEach(s => s.onclick = () => {
                paintColor = s.dataset.hex;
                document.getElementById('paintColor').value = paintColor;
                document.getElementById('paintHex').value = paintColor.toUpperCase();
            });
            buildKb('perkeyKb', k => {
                perkey[k.dataset.key] = paintColor;
                k.style.background = paintColor;
                k.style.boxShadow = `0 0 6px ${paintColor}`;
                k.classList.add('painted');
            });
        }

        document.getElementById('paintColor').oninput = e => { paintColor = e.target.value; document.getElementById('paintHex').value = paintColor.toUpperCase(); };
        document.getElementById('paintHex').onchange = e => { if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) { paintColor = e.target.value; document.getElementById('paintColor').value = paintColor; } };

        document.getElementById('presetSelect').onchange = e => {
            const keys = Array.from(document.querySelectorAll('#perkeyKb .kb-key')).filter(k => k.dataset.key);
            switch (e.target.value) {
                case 'rainbow':
                    // Use backend rainbow command
                    window.api?.send({ action: 'perkey-rainbow' });
                    setStatus('Rainbow applying...');
                    break;
                case 'gaming':
                    ['W', 'A', 'S', 'D', 'SPACE', 'LSHIFT', 'LCTRL', 'E', 'R', 'F', 'Q'].forEach(n => {
                        keys.filter(k => k.dataset.key === n).forEach(k => {
                            perkey[n] = '#FF0000'; k.style.background = '#FF0000'; k.style.boxShadow = '0 0 6px #FF0000'; k.classList.add('painted');
                        });
                    });
                    break;
                case 'gradient':
                    // Use backend gradient command
                    window.api?.send({ action: 'perkey-gradient', start: { r: 255, g: 0, b: 0 }, end: { r: 0, g: 0, b: 255 } });
                    setStatus('Gradient applying...');
                    break;
                case 'fill':
                    keys.forEach(k => { perkey[k.dataset.key] = paintColor; k.style.background = paintColor; k.style.boxShadow = `0 0 6px ${paintColor}`; k.classList.add('painted'); });
                    break;
                case 'clear':
                    perkey = {};
                    window.api?.send({ action: 'perkey-clear' });
                    initPerkey();
                    break;
            }
            e.target.value = '';
        };

        document.getElementById('reactiveToggle').onchange = e => {
            const a = e.target.checked;
            const r = parseInt(paintColor.slice(1, 3), 16);
            const g = parseInt(paintColor.slice(3, 5), 16);
            const b = parseInt(paintColor.slice(5, 7), 16);
            window.api?.send({ action: 'toggle-reactive', active: a, color: { r, g, b } });
            setStatus(a ? 'Reactive ON' : 'Reactive OFF');
        };

        // Visualizer
        function initVis() { buildKb('visKb'); }
        function updateVis(keys) {
            document.querySelectorAll('#visKb .kb-key').forEach(k => k.classList.remove('active'));
            keys.forEach(vk => {
                const n = VK[vk];
                if (n) document.querySelectorAll(`#visKb .kb-key[data-key="${n}"]`).forEach(k => k.classList.add('active'));
            });
            document.getElementById('keyCount').textContent = keys.length;
        }

        // Stats
        document.getElementById('resetBtn').onclick = () => { window.api?.resetStats(); sessStart = Date.now(); sessKeys = 0; document.getElementById('sessionKeys').textContent = '0'; setStatus('Reset'); };
        function updateTime() {
            const s = Math.floor((Date.now() - sessStart) / 1000);
            document.getElementById('sessionTime').textContent = `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`;
        }
        setInterval(updateTime, 1000);

        // Apply
        document.getElementById('applyBtn').onclick = () => {
            if (curPage === 'lighting') {
                const sp = +document.getElementById('speedSlider').value;
                const br = +document.getElementById('brightSlider').value;
                window.api?.setMode(selMode, selColor, sp, br, dir);
                setStatus('Applied');
            } else if (curPage === 'smart') {
                const en = document.getElementById('smartToggle').checked;
                const nf = document.getElementById('neighborToggle').checked;
                const to = +document.getElementById('timeoutSlider').value * 1000;
                window.api?.updateSettings({ idleTimeout: to, activeColor: actColor, idleColor });
                window.api?.toggleSmart(en);
                window.api?.send({ action: 'toggle-neighbor-flash', active: nf });
                setStatus(en ? 'Smart ON' : 'Saved');
            } else if (curPage === 'perkey') {
                // Use optimized batch apply
                window.api?.send({ action: 'perkey-all', r: 0, g: 0, b: 0 });
                setTimeout(() => {
                    const entries = Object.entries(perkey);
                    entries.forEach(([key, hex]) => {
                        let r, g, b;
                        if (hex.startsWith('rgb')) { [r, g, b] = hex.match(/\d+/g).map(Number); }
                        else { r = parseInt(hex.slice(1, 3), 16); g = parseInt(hex.slice(3, 5), 16); b = parseInt(hex.slice(5, 7), 16); }
                        window.api?.send({ action: 'perkey-key', key, r, g, b });
                    });
                    setTimeout(() => { window.api?.send({ action: 'perkey-apply' }); setStatus('Applied'); }, 100);
                }, 50);
            }
        };

        // IPC
        if (window.api) {
            window.api.onStatus(m => setStatus(m));
            window.api.onKey(() => { sessKeys++; document.getElementById('sessionKeys').textContent = sessKeys; });
            window.api.onStats(d => {
                document.getElementById('totalKeys').textContent = d.total?.toLocaleString() || '0';
                document.getElementById('kpmVal').textContent = d.kpm || '0';
                if (d.top) document.getElementById('topKeys').innerHTML = d.top.map((k, i) => `<div style="display:flex;justify-content:space-between;padding:4px;background:rgba(255,255,255,0.03);border-radius:2px;margin-bottom:2px;font-size:8px;"><span>${i + 1}. ${k.name}</span><span>${k.count}</span></div>`).join('');
            });
            window.api.onFullStats(d => updateVis(d.keys || []));
            window.api.getStats();
        }

        // Init
        initLight();
        initSmart();
        initPerkey();
        initVis();
    </script>
</body>

</html>